<!DOCTYPE html>

<html>

<head>

  <title>Tap Tap Cookie</title>

  <style>

    canvas {

      border: 1px solid black;

    }

    #loginButton {

      background-image: url('login-button.jpg');

      width: 150px;

      height: 50px;

      cursor: pointer;

    }

    #msDisplay {

      position: fixed;

      top: 10px;

      right: 10px;

      font-size: 14px;

    }

  </style>

  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>

</head>

<body>

  <div id="loginPage">

    <h1>Login</h1>

    <input type="text" id="usernameInput" placeholder="Username">

    <button id="guestButton" onclick="loginAsGuest()">Login as Guest</button>

  </div>

  <div id="gamePage" style="display: none;">

    <h1>Welcome, <span id="username"></span>!</h1>

    <h2>Score: <span id="score">0</span></h2>

    <canvas id="canvas"></canvas>

    <div id="msDisplay">Ping: <span id="ping">-</span> ms</div>

    <h2>Leaderboard</h2>

    <ol id="leaderboard"></ol>

  </div>

  <script>

    // Firebase Config

    var firebaseConfig = {

      apiKey: "AIzaSyBMUFoehYxHGwdXgDaQFwcYy1PiOQXnSkg",

      authDomain: "tapcookieonline.firebaseapp.com",

      databaseURL: "https://tapcookieonline-default-rtdb.firebaseio.com",

      projectId: "tapcookieonline",

      storageBucket: "tapcookieonline.appspot.com",

      messagingSenderId: "493293620415",

      appId: "1:493293620415:web:a1e97f68243dc3bbcd0a0a"

    };

    // Initialize Firebase

    firebase.initializeApp(firebaseConfig);

    var database = firebase.database();

    // Get leaderboard reference

    var leaderboardRef = database.ref('leaderboard');

    // Get DOM elements

    var loginPage = document.getElementById('loginPage');

    var gamePage = document.getElementById('gamePage');

    var canvas = document.getElementById('canvas');

    var scoreDisplay = document.getElementById('score');

    var usernameInput = document.getElementById('usernameInput');

    var usernameDisplay = document.getElementById('username');

    var pingDisplay = document.getElementById('ping');

    var leaderboardElement = document.getElementById('leaderboard');

    // Initialize score and click count

    var score = 0;

    var clickCount = 0;

    // Check authentication status when the page is loaded

    firebase.auth().onAuthStateChanged(function(user) {

      if (user) {

        // User is already logged in

        showGamePage(user.displayName);

      } else {

        // User is not logged in

        showLoginPage();

      }

    });

    function loginAsGuest() {

      var username = usernameInput.value.trim();

      if (username === '') {

        alert('Please enter a username.');

        return;

      }

      firebase.auth().signInAnonymously()

        .then(function(userCredential) {

          var user = userCredential.user;

          user.updateProfile({

            displayName: username

          }).then(function() {

            showGamePage(user.displayName);

          }).catch(function(error) {

            console.log(error);

          });

        })

        .catch(function(error) {

          console.log(error);

        });

    }

    function showLoginPage() {

      loginPage.style.display = 'block';

      gamePage.style.display = 'none';

    }

    function showGamePage(username) {

      usernameDisplay.textContent = username;

      loginPage.style.display = 'none';

      gamePage.style.display = 'block';

      leaderboardRef.orderByChild('score').limitToLast(10).on('value', function(snapshot) {

        var leaderboard = snapshot.val();

        updateLeaderboard(leaderboard);

      });

      startGame();

    }

    function startGame() {

      canvas.addEventListener('click', function() {

        if (!document.body.classList.contains('game-over')) {

          score++;

          scoreDisplay.textContent = score;

          clickCount++;

          updateClickCount(clickCount);

        }

      });

    }

    function updateClickCount(clickCount) {

      firebase.database().ref('clickCount').set(clickCount);

    }

    function updateLeaderboard(leaderboard) {

      leaderboardElement.innerHTML = '';

      var sortedLeaderboard = Object.entries(leaderboard).sort(function(a, b) {

        return b[1].score - a[1].score;

      });

      sortedLeaderboard.forEach(function(entry) {

        var username = entry[0];

        var score = entry[1].score;

        var leaderboardItem = document.createElement('li');

        leaderboardItem.textContent = username + ': ' + score;

        leaderboardElement.appendChild(leaderboardItem);

      });

    }

  </script>

</body>

</html>
